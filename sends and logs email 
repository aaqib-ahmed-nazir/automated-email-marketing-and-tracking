// Function to send an email with a tracking pixel
function sendEmail(recipient, subject, body, trackingId) {
  try {
    // Replace with your actual deployed Google Apps Script URL for the tracking pixel
    var trackingPixelUrl = "https://script.google.com/macros/s/AKfycbz7_yJx7GKiDcMWIxutR_bpPpsjwbGxHAZ4S-2wHP1m7pDUwwU5Ot5rl-cf1EVkLwTM/exec?trackingId=" + trackingId;

    // Add the tracking pixel to the HTML body (invisible 1x1 pixel)
    var bodyWithTracking = body + '<img src="' + trackingPixelUrl + '" width="1" height="1" style="display:none;" />';

    // Send the email with both plain text and HTML body
    MailApp.sendEmail({
      to: recipient,
      subject: subject,
      body: body,  // Plain text body for the email client
      htmlBody: bodyWithTracking  // HTML body to render the tracking pixel
    });

    return true;
  } catch (error) {
    Logger.log("Error sending email to " + recipient + ": " + error.message);
    return false;
  }
}

// Function to log email details in a Google Sheet
function logEmail(firstName, lastName, email, subject, emailSent, trackingId) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    // Log email details in the sheet
    var dateSent = new Date();
    sheet.appendRow([firstName, lastName, email, subject, dateSent, emailSent ? "Yes" : "No", trackingId, "No"]);

    Logger.log("Logged email details in sheet: " + firstName + " " + lastName + " " + trackingId);
  } catch (error) {
    Logger.log("Error logging email details: " + error.message);
  }
}

// Function to send email with tracking and log details
function sendEmailWithTracking(firstName, lastName, email, subject, body) {
  // Generate a unique Tracking ID for this email
  var trackingId = Utilities.getUuid();

  // Send the email with the tracking ID
  var emailSent = sendEmail(email, subject, body, trackingId);

  // Log and return the result
  if (emailSent) {
    // Log the email details in the Google Sheet
    logEmail(firstName, lastName, email, subject, true, trackingId);
    return ContentService.createTextOutput("Email sent successfully!");
  } else {
    return ContentService.createTextOutput("Failed to send email.");
  }
}

// Web app endpoint to handle email sending and logging (POST request)
function doPost(e) {
  try {
    // Parse parameters from the POST request
    var params = JSON.parse(e.postData.contents);

    var firstName = params.first_name;
    var lastName = params.last_name;
    var email = params.email;
    var subject = params.subject;
    var body = params.body;

    // Send the email with tracking and log the details
    return sendEmailWithTracking(firstName, lastName, email, subject, body);
  } catch (error) {
    Logger.log("Error in doPost: " + error.message);
    return ContentService.createTextOutput("Error: " + error.message).setMimeType(ContentService.MimeType.TEXT);
  }
}

// Web app endpoint for tracking pixel (GET request)
function doGet(e) {
  var trackingId = e.parameter.trackingId;
  Logger.log("Tracking Pixel Loaded with ID: " + trackingId);

  // Return a 1x1 pixel (placeholder content for simplicity)
  return ContentService.createTextOutput("1x1 pixel image here").setMimeType(ContentService.MimeType.PNG);
}